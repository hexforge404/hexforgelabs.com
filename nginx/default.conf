# --------------------------------------------
# Localhost test server (no redirect)
# Allows internal curl testing without HTTPS redirect
# --------------------------------------------
# --- HTTP redirect to HTTPS (default) ---
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;
    return 301 https://$host$request_uri;
}

# --- Localhost testing server (no redirect) ---
server {
    listen 8080;
    server_name localhost 127.0.0.1;

    location / {
        root /usr/share/nginx/html;
        try_files $uri =404;
        add_header Cache-Control "public, max-age=86400, immutable" always;
        add_header X-Content-Type-Options "nosniff" always;
    }
}


# --------------------------------------------
# HTTPS: main HexForge Labs site
# --------------------------------------------
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name hexforgelabs.com www.hexforgelabs.com;

      # --- Security / PWA Header Baseline ---
  add_header X-Content-Type-Options nosniff always;
  add_header Referrer-Policy no-referrer-when-downgrade always;
  add_header X-Frame-Options SAMEORIGIN always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

  # Ensure correct types for modern assets
  types {
    application/javascript                    js mjs;
    text/javascript                           mjs;
    application/manifest+json                 webmanifest manifest json;
    application/wasm                          wasm;
    font/woff2                                woff2;
    source-map                                map;
  }

  # Gzip/Brotli (if module present) — safe, common types
  gzip on;
  gzip_comp_level 5;
  gzip_min_length 1024;
  gzip_types
    text/plain text/css application/json application/javascript
    application/manifest+json application/xml text/xml image/svg+xml
    font/woff2;
  gzip_vary on;

  # --- Caching policy ---
  # 1) Hashed static assets (js/css/map/woff2) — 1 year + immutable
  location ~* \.(?:js|mjs|css|map|woff2)$ {
    try_files $uri =404;
    add_header Cache-Control "public, max-age=31536000, immutable" always;
  }

  # 2) PWA manifest (JSON) — 1 day + immutable
  location = /manifest.json {
    try_files $uri =404;
    default_type application/manifest+json;
    add_header Cache-Control "public, max-age=86400, immutable" always;
    add_header X-Content-Type-Options nosniff always;
  }

  # 3) Service worker — never cache
  location = /sw.js {
    try_files $uri =404;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
  }

  # 4) HTML — never cache
  location ~* \.html?$ {
    try_files $uri /index.html;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
  }


    # SSL (Let’s Encrypt)
    ssl_certificate     /etc/letsencrypt/live/hexforgelabs.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/hexforgelabs.com/privkey.pem;

    # Root build directory (React)
    root /usr/share/nginx/html;
    index index.html;

    client_max_body_size 20m;

      # Images & icons — long immutable cache
  location ~* \.(?:png|jpg|jpeg|gif|svg|webp|ico)$ {
    try_files $uri =404;
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    add_header X-Content-Type-Options nosniff always;
  }


    # ----------------------------------------
    # Single-Page App routing (React)
    # ----------------------------------------
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ----------------------------------------
    # Backend API (Express)
    # ----------------------------------------
    location /api/ {
        proxy_pass         http://hexforge-backend:8000;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Connection        "";
    }

    # ----------------------------------------
    # Assistant (FastAPI)
    # ----------------------------------------
    location /mcp/ {
    if ($request_method = OPTIONS) {
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
        add_header Access-Control-Max-Age 86400 always;
        return 204;
    }
    proxy_set_header Origin $http_origin;
        proxy_pass         http://hexforge-assistant:11435/mcp/;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Connection        "";
    }

    location /tool/ {
        proxy_pass         http://hexforge-assistant:11435/tool/;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Connection        "";
    }

    # ----------------------------------------
    # WebSocket (optional, for Assistant)
    # ----------------------------------------
    location /ws {
  proxy_pass         http://hexforge-assistant:11435;
  proxy_http_version 1.1;
  proxy_set_header   Upgrade           $http_upgrade;
  proxy_set_header   Connection        "upgrade";
  proxy_set_header   Host              $host;
  proxy_read_timeout  3600;
  proxy_send_timeout  3600;
  proxy_buffering     off;
}


    
}
