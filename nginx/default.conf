# /etc/nginx/conf.d/default.conf
# HexForge Labs — Main Site + Tools subdomain (stable)

# -------------------------------------------------
# Cloudflare HTTPS detection (works inside http{} context)
# -------------------------------------------------
map $http_x_forwarded_proto $redirect_to_https {
    default 0;
    https   0;
    http    1;
}

# -------------------------------------------------
# HTTP -> HTTPS
# -------------------------------------------------
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name hexforgelabs.com www.hexforgelabs.com tools.hexforgelabs.com;
    return 301 https://$host$request_uri;
}

# -------------------------------------------------
# Optional local HTTP test port
# -------------------------------------------------
server {
    listen 8088;
    server_name localhost 127.0.0.1;

    root  /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://hexforge-backend:8000;
        proxy_http_version 1.1;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection        "";
    }
}

# -------------------------------------------------
# MAIN SITE: hexforgelabs.com
# -------------------------------------------------
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name hexforgelabs.com www.hexforgelabs.com;

    ssl_certificate     /etc/letsencrypt/live/hexforgelabs.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/hexforgelabs.com/privkey.pem;

    # If Cloudflare hits us over http internally, force https
    if ($redirect_to_https) {
        return 301 https://$host$request_uri;
    }

    # --- Security headers ---
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header X-Frame-Options "SAMEORIGIN" always;

    root  /usr/share/nginx/html;
    index index.html;

    client_max_body_size 50m;

    # Kill bot probes fast (no PHP here, go away)
    location ~* \.(?:php|phtml|phar|cgi)$ { return 444; }
    location ~* ^/(?:wp-admin|wp-includes|wp-content|xmlrpc\.php) { return 444; }
    location ~* ^/(?:cgi-bin|\.git|\.env) { return 444; }


    # --- Static caching (hashed assets) ---
    location ~* \.(?:css|js|mjs|map|woff2)$ {
        try_files $uri =404;
        add_header Cache-Control "public, max-age=31536000, immutable" always;
        access_log off;
    }

    location ~* \.(?:png|jpg|jpeg|gif|svg|webp|ico)$ {
        try_files $uri =404;
        add_header Cache-Control "public, max-age=31536000, immutable" always;
        add_header X-Content-Type-Options "nosniff" always;
        access_log off;
    }

    # If you’re serving uploaded images from a host path mounted at /uploads
    # (Only keep this if /uploads exists inside the container)
    location ^~ /images/ {
        alias /uploads/;
        add_header Cache-Control "public, max-age=2592000" always; # 30d
        add_header X-Content-Type-Options "nosniff" always;
        access_log off;
    }

    # Heightmap outputs (generated files)
    location ^~ /assets/heightmap/ {
        alias /var/www/hexforge3d/output/;
        autoindex off;
        add_header Cache-Control "public, max-age=86400" always; # 1d
        add_header X-Content-Type-Options "nosniff" always;
    }

    # --- React SPA routing ---
    location / {
        try_files $uri $uri/ /index.html;
    }

    # --- Backend API ---
    location /api/ {
        proxy_pass http://hexforge-backend:8000;
        proxy_http_version 1.1;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection        "";
    }

    # --- Assistant (FastAPI) ---
    location /mcp/ {
        proxy_pass http://hexforge-assistant:11435/mcp/;
        proxy_http_version 1.1;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection        "";

        proxy_read_timeout 3600;
        proxy_send_timeout 3600;
        proxy_buffering off;
    }

    location /tool/ {
        proxy_pass http://hexforge-assistant:11435/tool/;
        proxy_http_version 1.1;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection        "";

        proxy_read_timeout 600s;
        proxy_send_timeout 600s;
        proxy_connect_timeout 60s;
        proxy_request_buffering off;
        proxy_buffering off;
    }

    location /ws {
        proxy_pass http://hexforge-assistant:11435;
        proxy_http_version 1.1;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host       $host;

        proxy_read_timeout 3600;
        proxy_send_timeout 3600;
        proxy_buffering off;
    }

    location = /health {
        add_header Content-Type text/plain always;
        return 200 "OK\n";
    }


    location ~ /\. {
        deny all;
    }
}

# -------------------------------------------------
# TOOLS SUBDOMAIN: tools.hexforgelabs.com
# -------------------------------------------------
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name tools.hexforgelabs.com;

    ssl_certificate     /etc/letsencrypt/live/hexforgelabs.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/hexforgelabs.com/privkey.pem;

    client_max_body_size 50m;

    # -------------------------------------------------
    # Security Headers (server-wide, inherited by all locations)
    # -------------------------------------------------
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header X-Frame-Options "SAMEORIGIN" always;

    # -------------------------------------------------
    # Tool API routes
    # -------------------------------------------------
    location /tool/ {
        proxy_pass http://hexforge-assistant:11435/tool/;
        proxy_http_version 1.1;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection        "";

        proxy_read_timeout 600s;
        proxy_send_timeout 600s;
        proxy_connect_timeout 60s;

        proxy_request_buffering off;
        proxy_buffering off;
    }

    # -------------------------------------------------
    # Heightmap asset output (static)
    # -------------------------------------------------
    location ^~ /assets/heightmap/ {
        alias /var/www/hexforge3d/output/;
        autoindex off;
        add_header Cache-Control "public, max-age=86400" always;
    }

    # -------------------------------------------------
    # FastAPI schema + docs
    # -------------------------------------------------
    location = /openapi.json {
        proxy_pass http://hexforge-assistant:11435/openapi.json;
        proxy_http_version 1.1;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location = /docs {
        proxy_pass http://hexforge-assistant:11435/docs;
        proxy_http_version 1.1;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ^~ /docs/ {
        proxy_pass http://hexforge-assistant:11435/docs/;
        proxy_http_version 1.1;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
