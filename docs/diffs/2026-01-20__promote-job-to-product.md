# Diff Report: promote-job-to-product

**Date:** 2026-01-20  
**Author:** Robert Duff  
**Branch:** feature/promote-job-to-product  
**Base:** main  
**Commit Range:** main..HEAD

## Summary

This diff report documents changes made in the `feature/promote-job-to-product` branch compared to `main`.

**Total Changes:**
- **Files Changed:** 20
- **Insertions:** 6279
- **Deletions:** 896

## Commits in This Change

- test(backend): stabilize Jest with mongodb-memory-server + env stubs (63de2bd)
- Wire store/admin UI to product catalog (a1ccbcc)
- Add product catalog models and admin promote-from-job endpoint (bc2fe46)
- Fix surface job payload aliasing and subfolder defaults; add debug gates (16775b8)
- Harden surface smoke/e2e scripts; handle http->https and JSON safety (1096895)
- Make admin session check lazy; stabilize SurfacePage fetch ordering (6bdf59f)

## Changed Files

- `README.md` (M: +50, -0)
- `backend/__tests__/products.from-surface-job.test.js` (A: +144, -0)
- `backend/jest.setup.js` (A: +17, -0)
- `backend/main.js` (M: +38, -28)
- `backend/models/Product.js` (M: +106, -116)
- `backend/models/ProductAsset.js` (A: +41, -0)
- `backend/package-lock.json` (M: +4572, -605)
- `backend/package.json` (M: +16, -1)
- `backend/routes/admin.js` (M: +60, -2)
- `backend/routes/products.js` (M: +405, -67)
- `backend/routes/surface.js` (M: +67, -12)
- `docker-compose.yml` (M: +1, -1)
- `frontend/src/components/ProductList.jsx` (M: +41, -15)
- `frontend/src/pages/AdminPage.jsx` (M: +9, -7)
- `frontend/src/pages/SurfacePage.jsx` (M: +253, -1)
- `frontend/src/pages/__tests__/SurfacePage.test.jsx` (M: +9, -6)
- `nginx/default.conf` (M: +13, -1)
- `scripts/e2e_surface_proof.sh` (A: +228, -0)
- `scripts/smoke_surface_stack.sh` (M: +110, -21)
- `scripts/smoke_surface_ui_check.sh` (M: +99, -13)

## Detailed Changes by File


### `README.md`

**Changes:** +50, -0

```diff
diff --git a/README.md b/README.md
index e9c93b3..cf68b1d 100644
--- a/README.md
+++ b/README.md
@@ -53,6 +53,56 @@ See [LICENSE.txt](./LICENSE.txt) for full terms.
 
 ---
 
+## ðŸ§ª Surface smoke / E2E helpers
+
+Use `BASE_URL` as the canonical endpoint (auto-falls back to `SURFACE_SMOKE_BASE_URL` / `SURFACE_BASE_URL`, default `https://localhost`). `http://localhost` is allowed but will be auto-upgraded to `https://localhost`. Set `CURL_INSECURE=1` only for local self-signed TLS.
+
+- Local (self-signed):
+  - `CURL_INSECURE=1 BASE_URL=https://localhost HEIGHTMAP_URL="<public heightmap png>" \`
+    `./scripts/smoke_surface_stack.sh`
+  - `CURL_INSECURE=1 BASE_URL=https://localhost ./scripts/smoke_surface_ui_check.sh "<job_id>"`
+  - `CURL_INSECURE=1 BASE_URL=https://localhost HEIGHTMAP_URL="<public heightmap png>" \`
+    `./scripts/e2e_surface_proof.sh`
+- Live (public certs):
+  - `BASE_URL=https://hexforgelabs.com HEIGHTMAP_URL="<public heightmap png>" \`
+    `./scripts/smoke_surface_stack.sh`
+  - `BASE_URL=https://hexforgelabs.com ./scripts/smoke_surface_ui_check.sh "<job_id>"`
+  - `BASE_URL=https://hexforgelabs.com HEIGHTMAP_URL="<public heightmap png>" \`
+    `./scripts/e2e_surface_proof.sh`
+
+---
+
+  ## ðŸ“¦ Promote Surface Job â†’ Product
+
+  Admins can convert a completed surface job into a store product and freeze the generated asset URLs.
+
+  - **Endpoint (admin-only, session cookie):** `POST /api/products/from-surface-job`
+  - Requires: `job_id`, optional `subfolder`, plus `title`, `price`, `category`, `description`, `tags`, `sku`, `freeze_assets`.
+  - Validation: job status must be `complete`, hero preview and STL must exist in the manifest. URLs are resolved from `manifest.public.*`, `public_root`, or `/assets/surface/<subfolder>/<job_id>/...`.
+  - Assets captured as `ProductAsset` rows: hero preview, STL, textures (if present), heightmap (if present), manifest URL.
+
+  Example (assumes admin session cookie already issued via `/api/auth/login`):
+
+  ```
+  curl -X POST http://localhost:8000/api/products/from-surface-job \
+    -H "Content-Type: application/json" \
+    -b "hexforge.sid=<admin-session-cookie>" \
+    -d '{
+      "job_id": "abc123",
+      "subfolder": "smoke-test",
+      "title": "Relief Shell",
+      "price": 129.00,
+      "category": "surface",
+      "description": "Relief enclosure auto-generated by Surface Engine",
+      "tags": ["surface", "relief"],

... (diff truncated, 11 more lines)
```


### `backend/__tests__/products.from-surface-job.test.js`

**Changes:** +144, -0

```diff
diff --git a/backend/__tests__/products.from-surface-job.test.js b/backend/__tests__/products.from-surface-job.test.js
new file mode 100644
index 0000000..722290a
--- /dev/null
+++ b/backend/__tests__/products.from-surface-job.test.js
@@ -0,0 +1,144 @@
+const request = require('supertest');
+const mongoose = require('mongoose');
+const { MongoMemoryServer } = require('mongodb-memory-server');
+const bcrypt = require('bcryptjs');
+
+const Product = require('../models/Product');
+const ProductAsset = require('../models/ProductAsset');
+
+describe('POST /api/products/from-surface-job', () => {
+  let mongo;
+  let app;
+  let agent;
+  let originalFetch;
+
+  beforeAll(async () => {
+    mongo = await MongoMemoryServer.create();
+    const uri = mongo.getUri();
+
+    process.env.NODE_ENV = 'test';
+    process.env.MONGO_URI = uri;
+    process.env.SESSION_SECRET = 'test-session-secret';
+    process.env.SURFACE_PUBLIC_PREFIX = '/assets/surface';
+    process.env.SURFACE_OUTPUT_DIR = '/tmp';
+    process.env.ADMIN_USERNAME = 'admin';
+    process.env.ADMIN_PASSWORD_HASH = await bcrypt.hash('super-secret', 4);
+
+    app = require('../main');
+    await mongoose.connect(uri);
+    agent = request.agent(app);
+    originalFetch = global.fetch;
+  });
+
+  afterAll(async () => {
+    await mongoose.disconnect();
+    if (mongo) await mongo.stop();
+    global.fetch = originalFetch;
+  });
+
+  afterEach(async () => {
+    await Product.deleteMany({});
+    await ProductAsset.deleteMany({});
+    global.fetch = originalFetch;
+    agent = request.agent(app);
+  });

... (diff truncated, 100 more lines)
```


### `backend/jest.setup.js`

**Changes:** +17, -0

```diff
diff --git a/backend/jest.setup.js b/backend/jest.setup.js
new file mode 100644
index 0000000..95457bf
--- /dev/null
+++ b/backend/jest.setup.js
@@ -0,0 +1,17 @@
+// Force mongodb-memory-server to use a Debian 12 compatible binary (>=7.0.3).
+process.env.MONGOMS_VERSION = process.env.MONGOMS_VERSION || '7.0.14';
+// Provide dummy Mailgun credentials so routes can initialize without failing during tests.
+process.env.MAILGUN_API_KEY = process.env.MAILGUN_API_KEY || 'test-mailgun-key';
+process.env.MAILGUN_DOMAIN = process.env.MAILGUN_DOMAIN || 'example.test';
+process.env.MAILGUN_FROM_EMAIL = process.env.MAILGUN_FROM_EMAIL || 'noreply@example.test';
+process.env.TO_EMAIL = process.env.TO_EMAIL || 'to@example.test';
+process.env.BCC_EMAIL = process.env.BCC_EMAIL || '';
+process.env.STRIPE_SECRET_KEY = process.env.STRIPE_SECRET_KEY || 'sk_test_dummy';
+
+jest.setTimeout(30000);
+
+const originalFetch = global.fetch;
+
+afterAll(() => {
+  global.fetch = originalFetch;
+});
```


### `backend/main.js`

**Changes:** +38, -28

```diff
diff --git a/backend/main.js b/backend/main.js
index a1cedbc..fb1b63e 100644
--- a/backend/main.js
+++ b/backend/main.js
@@ -112,21 +112,26 @@ app.use(mongoSanitize());
 // ======================
 // SESSION CONFIGURATION
 // ======================
+const useMemorySessionStore = process.env.NODE_ENV === 'test';
+const sessionStore = useMemorySessionStore
+  ? new session.MemoryStore()
+  : MongoStore.create({
+      mongoUrl: process.env.MONGO_URI,
+      ttl: 24 * 60 * 60,
+    });
+
 app.use(session({
-  secret: process.env.SESSION_SECRET,
+  secret: process.env.SESSION_SECRET || 'hexforge-test-secret',
   name: 'hexforge.sid',
   resave: false,
   saveUninitialized: false,
-  store: MongoStore.create({
-    mongoUrl: process.env.MONGO_URI,
-    ttl: 24 * 60 * 60
-  }),
-  cookie: { 
-    secure: process.env.NODE_ENV === 'production',
+  store: sessionStore,
+  cookie: {
+    secure: process.env.NODE_ENV === 'production' && !useMemorySessionStore,
     httpOnly: true,
     sameSite: 'lax',
-    maxAge: 24 * 60 * 60 * 1000
-  }
+    maxAge: 24 * 60 * 60 * 1000,
+  },
 }));
 
 // ======================
@@ -215,28 +220,31 @@ mongoose.connection.on('disconnected', () => {
   console.log('âš ï¸  MongoDB disconnected');
 });
 
-mongoose.connect(process.env.MONGO_URI, mongooseOptions)
-  .then(() => {
-    console.log('âœ… MongoDB connected successfully');
-    
-    const server = app.listen(PORT, () => {
-      console.log(`ðŸš€ Server running on port ${PORT}`);

... (diff truncated, 47 more lines)
```


### `backend/models/Product.js`

**Changes:** +106, -116

```diff
diff --git a/backend/models/Product.js b/backend/models/Product.js
index 0d6588f..1203953 100644
--- a/backend/models/Product.js
+++ b/backend/models/Product.js
@@ -1,132 +1,122 @@
 const mongoose = require('mongoose');
 
-const productSchema = new mongoose.Schema({
-  name: {
-    type: String,
-    required: [true, 'Product name is required'],
-    unique: true,
-    trim: true,
-    maxlength: [100, 'Product name cannot exceed 100 characters']
-  },
-  description: {
-    type: String,
-    trim: true,
-    maxlength: [2000, 'Description cannot exceed 2000 characters']
-  },
-  price: {
-    type: Number,
-    required: [true, 'Price is required'],
-    min: [0.01, 'Price must be at least 0.01'],
-    set: v => parseFloat(v.toFixed(2)) // Always store 2 decimal places
-  },
-  image: {
-    type: String,
-    validate: {
-      validator: function(v) {
-        return (
-          /^\/images\/.+\.(jpg|jpeg|png|webp|gif)$/i.test(v) || 
-          /^[^/]+\.(jpg|jpeg|png|webp|gif)$/i.test(v) ||
-          /^(https?:\/\/).+\.(jpg|jpeg|png|webp|gif)$/i.test(v)
-        );
-      },
-      message: props => `${props.value} must be a valid image URL or a relative /images path!`
-    }
-  },
-  brand: {
-    type: String,
-    required: [true, 'Brand is required'],
-    trim: true,
-    maxlength: [50, 'Brand name cannot exceed 50 characters']
-  
-  
-  },
-  stock: {
-    type: Number,
-    default: 0,

... (diff truncated, 193 more lines)
```


### `backend/models/ProductAsset.js`

**Changes:** +41, -0

```diff
diff --git a/backend/models/ProductAsset.js b/backend/models/ProductAsset.js
new file mode 100644
index 0000000..2d507a6
--- /dev/null
+++ b/backend/models/ProductAsset.js
@@ -0,0 +1,41 @@
+const mongoose = require('mongoose');
+
+const productAssetSchema = new mongoose.Schema(
+  {
+    product: {
+      type: mongoose.Schema.Types.ObjectId,
+      ref: 'Product',
+      required: true,
+      index: true,
+    },
+    type: {
+      type: String,
+      required: true,
+      trim: true,
+    },
+    url: {
+      type: String,
+      required: true,
+      trim: true,
+    },
+    checksum: {
+      type: String,
+      trim: true,
+    },
+    size_bytes: {
+      type: Number,
+      min: 0,
+    },
+    meta: {
+      type: mongoose.Schema.Types.Mixed,
+      default: {},
+    },
+  },
+  {
+    timestamps: true,
+  }
+);
+
+productAssetSchema.index({ product: 1, type: 1 });
+
+module.exports = mongoose.model('ProductAsset', productAssetSchema);
```


### `backend/package-lock.json`

**Changes:** +4572, -605

```diff
diff --git a/backend/package-lock.json b/backend/package-lock.json
index 12bbb4b..36cf2f9 100644
--- a/backend/package-lock.json
+++ b/backend/package-lock.json
@@ -31,817 +31,3572 @@
         "strip-ansi": "^6.0.1",
         "stripe": "^17.7.0",
         "uuid": "^9.0.0"
+      },
+      "devDependencies": {
+        "@types/jest": "^29.5.14",
+        "jest": "^29.7.0",
+        "mongodb-memory-server": "^9.1.8",
+        "supertest": "^7.1.1"
       }
     },
-    "node_modules/@mongodb-js/saslprep": {
-      "version": "1.2.0",
-      "resolved": "https://registry.npmjs.org/@mongodb-js/saslprep/-/saslprep-1.2.0.tgz",
-      "integrity": "sha512-+ywrb0AqkfaYuhHs6LxKWgqbh3I72EpEgESCw37o+9qPx9WTCkgDm2B+eMrwehGtHBWHFU4GXvnSCNiFhhausg==",
+    "node_modules/@babel/code-frame": {
+      "version": "7.28.6",
+      "resolved": "https://registry.npmjs.org/@babel/code-frame/-/code-frame-7.28.6.tgz",
+      "integrity": "sha512-JYgintcMjRiCvS8mMECzaEn+m3PfoQiyqukOMCCVQtoJGYJw8j/8LBJEiqkHLkfwCcs74E3pbAUFNg7d9VNJ+Q==",
+      "dev": true,
       "dependencies": {
-        "sparse-bitfield": "^3.0.3"
+        "@babel/helper-validator-identifier": "^7.28.5",
+        "js-tokens": "^4.0.0",
+        "picocolors": "^1.1.1"
+      },
+      "engines": {
+        "node": ">=6.9.0"
       }
     },
-    "node_modules/@notionhq/client": {
-      "version": "3.0.1",
-      "resolved": "https://registry.npmjs.org/@notionhq/client/-/client-3.0.1.tgz",
-      "integrity": "sha512-vHtFKrRKQg2PZSky1A9fTe+L9/WxNYRJWHmD6ZiBNgeN5jnFmv27ootRl9ROzEm/N+mOxfTo37EnuCHsaPgETg==",
-      "license": "MIT",
+    "node_modules/@babel/compat-data": {
+      "version": "7.28.6",
+      "resolved": "https://registry.npmjs.org/@babel/compat-data/-/compat-data-7.28.6.tgz",
+      "integrity": "sha512-2lfu57JtzctfIrcGMz992hyLlByuzgIk58+hhGCxjKZ3rWI82NnVLjXcaTqkI2NvlcvOskZaiZ5kjUALo3Lpxg==",
+      "dev": true,
       "engines": {
-        "node": ">=18"
+        "node": ">=6.9.0"
       }
     },

... (diff truncated, 5646 more lines)
```


### `backend/package.json`

**Changes:** +16, -1

```diff
diff --git a/backend/package.json b/backend/package.json
index 9624cf3..0994517 100644
--- a/backend/package.json
+++ b/backend/package.json
@@ -5,7 +5,7 @@
   "description": "",
   "main": "main.js",
   "scripts": {
-    "test": "echo \"Error: no test specified\" && exit 1",
+    "test": "NODE_ENV=test jest --runInBand",
     "start": "node main.js"
   },
   "keywords": [],
@@ -33,5 +33,20 @@
     "strip-ansi": "^6.0.1",
     "stripe": "^17.7.0",
     "uuid": "^9.0.0"
+  },
+  "devDependencies": {
+    "@types/jest": "^29.5.14",
+    "jest": "^29.7.0",
+    "mongodb-memory-server": "^9.1.8",
+    "supertest": "^7.1.1"
+  },
+  "jest": {
+    "testEnvironment": "node",
+    "roots": [
+      "<rootDir>/__tests__"
+    ],
+    "setupFilesAfterEnv": [
+      "<rootDir>/jest.setup.js"
+    ]
   }
 }
```


### `backend/routes/admin.js`

**Changes:** +60, -2

```diff
diff --git a/backend/routes/admin.js b/backend/routes/admin.js
index 0b2c214..187156f 100644
--- a/backend/routes/admin.js
+++ b/backend/routes/admin.js
@@ -7,6 +7,8 @@ const Order = require('../models/Order');
 const multer = require('multer');
 const path = require('path');
 
+const STATUS_VALUES = ['draft', 'active', 'archived'];
+
 const uploadDir = path.join(__dirname, '../../frontend/public/images');
 const storage = multer.diskStorage({
   destination: uploadDir,
@@ -67,10 +69,18 @@ const validateProduct = [
 ];
 
 // GET all products
+function mapProduct(product) {
+  const obj = product.toObject({ virtuals: true });
+  obj.name = obj.name || obj.title;
+  obj.image = obj.image || obj.hero_image_url;
+  obj.priceFormatted = obj.priceFormatted || (typeof obj.price === 'number' ? `$${obj.price.toFixed(2)}` : '$0.00');
+  return obj;
+}
+
 router.get('/products', async (req, res) => {
   try {
-    const products = await Product.find().sort({ createdAt: -1 });
-    res.json(products);
+    const products = await Product.find().sort({ created_at: -1 });
+    res.json(products.map(mapProduct));
   } catch (err) {
     console.error('âŒ Failed to fetch products:', err);
     res.status(500).json({
@@ -142,6 +152,54 @@ router.put('/products/:id', validateProduct, async (req, res) => {
   }
 });
 
+// PATCH product (status + metadata)
+router.patch('/products/:id', async (req, res) => {
+  try {
+    const update = {};
+    if (req.body.title || req.body.name) update.title = (req.body.title || req.body.name || '').trim();
+    if (req.body.description) update.description = req.body.description;
+    if (req.body.category) update.category = req.body.category;
+    if (req.body.hero_image_url || req.body.image) update.hero_image_url = req.body.hero_image_url || req.body.image;
+    if (req.body.tags) {
+      update.tags = Array.isArray(req.body.tags)
+        ? req.body.tags
+        : String(req.body.tags)

... (diff truncated, 39 more lines)
```


### `backend/routes/products.js`

**Changes:** +405, -67

```diff
diff --git a/backend/routes/products.js b/backend/routes/products.js
index 0297249..ecbfa0a 100644
--- a/backend/routes/products.js
+++ b/backend/routes/products.js
@@ -2,140 +2,376 @@ const express = require('express');
 const router = express.Router();
 const { body, validationResult } = require('express-validator');
 const rateLimit = require('express-rate-limit');
+const path = require('path');
+const fs = require('fs/promises');
 const Product = require('../models/Product');
+const ProductAsset = require('../models/ProductAsset');
+const { requireAdmin } = require('../middleware/requireAdmin');
+
+const SURFACE_PUBLIC_PREFIX = (process.env.SURFACE_PUBLIC_PREFIX || '/assets/surface').replace(/\/+$/, '');
+const SURFACE_OUTPUT_DIR = process.env.SURFACE_OUTPUT_DIR || '/var/www/hexforge3d/surface';
+const INTERNAL_BASE_URL = process.env.INTERNAL_BASE_URL || process.env.SURFACE_INTERNAL_BASE_URL || 'http://localhost:8000';
+const STATUS_VALUES = ['draft', 'active', 'archived'];
+const REQUEST_TIMEOUT_MS = 8000;
 
-// Rate limiting configuration
 const productLimiter = rateLimit({
-  windowMs: 15 * 60 * 1000, // 15 minutes
-  max: 100, // limit each IP to 100 requests per windowMs
-  message: 'Too many product requests, please try again later'
+  windowMs: 15 * 60 * 1000,
+  max: 100,
+  message: 'Too many product requests, please try again later',
 });
 
-// Product validation rules
-const validateProduct = [
-  body('name').trim().notEmpty().withMessage('Product name is required'),
-  body('description').optional().trim().escape(),
-  body('price')
-  .isFloat({ min: 0.01 })
-  .withMessage('Price must be at least $0.01'),
-  body('image')
-  .optional()
-  .matches(/^\/images\/.+\.(jpg|jpeg|png|webp|gif)$|^[^/]+\.(jpg|jpeg|png|webp|gif)$|^https?:\/\/.+\.(jpg|jpeg|png|webp|gif)$/i)
-  .withMessage('Image must be a valid path or URL ending in .jpg, .png, etc.'),
-  
-  body('stock').optional().isInt({ min: 0 }).withMessage('Stock must be 0 or greater'),
-  body('categories').optional().isArray(),
-  body('isFeatured').optional().isBoolean()
+const baseProductValidation = [
+  body('title').optional().isString().trim().notEmpty(),
+  body('name').optional().isString().trim().notEmpty(),
+  body('description').optional().isString(),
+  body('price').optional().isFloat({ min: 0 }),

... (diff truncated, 536 more lines)
```


### `backend/routes/surface.js`

**Changes:** +67, -12

```diff
diff --git a/backend/routes/surface.js b/backend/routes/surface.js
index 163bc81..7a5007a 100644
--- a/backend/routes/surface.js
+++ b/backend/routes/surface.js
@@ -10,7 +10,8 @@ const SURFACE_ENGINE_BASE = process.env.SURFACE_ENGINE_URL || "http://surface-en
 const BASIC_AUTH = process.env.SURFACE_ENGINE_BASIC_AUTH || "";
 const API_KEY = process.env.SURFACE_ENGINE_API_KEY || "";
 const SURFACE_API_KEY = process.env.SURFACE_API_KEY || "";
-const DEFAULT_SUBFOLDER = process.env.SURFACE_DEFAULT_SUBFOLDER || "";
+const SMOKE_MODE = (process.env.SURFACE_SMOKE_MODE || "").toLowerCase() === "1";
+const DEFAULT_SUBFOLDER = process.env.SURFACE_DEFAULT_SUBFOLDER || (SMOKE_MODE ? "smoke-test" : "");
 const SURFACE_OUTPUT_DIR = process.env.SURFACE_OUTPUT_DIR || "/var/www/hexforge3d/surface";
 const SURFACE_PUBLIC_PREFIX = process.env.SURFACE_PUBLIC_PREFIX || "/assets/surface";
 const SURFACE_DEBUG = (process.env.SURFACE_DEBUG || "").toLowerCase() === "1";
@@ -151,6 +152,16 @@ function debugLog(...args) {
   }
 }
 
+function pickHeightmapUrl(payload = {}) {
+  return (
+    payload.heightmap_url ||
+    payload.source_heightmap_url ||
+    payload.heightmapUrl ||
+    payload.source_heightmapUrl ||
+    null
+  );
+}
+
 function buildManifestUrl(subfolder, jobId) {
   const trimmed = [SURFACE_PUBLIC_PREFIX.replace(/\/$/, ""), subfolder, jobId, "job_manifest.json"].filter(Boolean);
   return trimmed.join("/").replace(/\/+/g, "/");
@@ -169,14 +180,41 @@ async function fileExists(filePath) {
 router.post("/jobs", limiter, async (req, res) => {
   try {
     const payload = { ...(req.body || {}) };
-    if (!payload.subfolder && DEFAULT_SUBFOLDER) {
+    let effectiveSubfolder = payload.subfolder || "";
+    if (!effectiveSubfolder && DEFAULT_SUBFOLDER) {
       payload.subfolder = DEFAULT_SUBFOLDER;
+      effectiveSubfolder = DEFAULT_SUBFOLDER;
+    }
+
+    const heightmapUrl = pickHeightmapUrl(payload);
+    if (!payload.heightmap_url && heightmapUrl) {
+      payload.heightmap_url = heightmapUrl;
     }
+    if (!payload.source_heightmap_url && heightmapUrl) {
+      payload.source_heightmap_url = heightmapUrl;
+    }
+    if (!payload.heightmap_job_id && payload.source_heightmap_job_id) {

... (diff truncated, 103 more lines)
```


### `docker-compose.yml`

**Changes:** +1, -1

```diff
diff --git a/docker-compose.yml b/docker-compose.yml
index 4ccdf4e..e5b9ae2 100644
--- a/docker-compose.yml
+++ b/docker-compose.yml
@@ -84,7 +84,7 @@ services:
       MEDIA_API_URL: http://hexforge-media-api:8700
       MEDIA_API_KEY: ${MEDIA_API_KEY}
       SURFACE_API_KEY: ${SURFACE_API_KEY:-}
-      SURFACE_DEFAULT_SUBFOLDER: ${SURFACE_DEFAULT_SUBFOLDER:-smoke-test}
+      SURFACE_DEFAULT_SUBFOLDER: ${SURFACE_DEFAULT_SUBFOLDER:-}
       SURFACE_OUTPUT_DIR: /var/www/hexforge3d/surface
 
     healthcheck:
```


### `frontend/src/components/ProductList.jsx`

**Changes:** +41, -15

```diff
diff --git a/frontend/src/components/ProductList.jsx b/frontend/src/components/ProductList.jsx
index ee70b41..45445c4 100644
--- a/frontend/src/components/ProductList.jsx
+++ b/frontend/src/components/ProductList.jsx
@@ -2,14 +2,39 @@ import { toast } from 'react-toastify';
 import React, { useEffect, useState } from 'react';
 import { useCart } from 'context/CartContext';
 
+const FALLBACK_PRODUCTS = [
+  {
+    _id: 'fallback-1',
+    title: 'Surface Relief Case',
+    price: 129,
+    hero_image_url: '/images/hexforge-logo-removebg.png',
+    category: 'surface',
+  },
+  {
+    _id: 'fallback-2',
+    title: 'Relief Shell',
+    price: 89,
+    hero_image_url: '/images/hexforge-logo-removebg.png',
+    category: 'surface',
+  },
+];
+
+const normalizeProduct = (product) => {
+  const price = Number(product.price);
+  return {
+    ...product,
+    name: product.name || product.title || 'Untitled product',
+    image: product.image || product.hero_image_url || '',
+    priceFormatted: product.priceFormatted || (Number.isFinite(price) ? `$${price.toFixed(2)}` : '$0.00'),
+  };
+};
+
 const getImageSrc = (image) => {
   if (!image) {
     return process.env.PUBLIC_URL + '/images/hexforge-logo-removebg.png';
   }
   if (image.startsWith('http')) return image;
-  if (image.startsWith('/images/')) {
-    return process.env.PUBLIC_URL + image;
-  }
+  if (image.startsWith('/')) return image;
   return process.env.PUBLIC_URL + '/images/' + image;
 };
 
@@ -22,12 +47,18 @@ function ProductList() {
   useEffect(() => {
     async function fetchProducts() {

... (diff truncated, 42 more lines)
```


### `frontend/src/pages/AdminPage.jsx`

**Changes:** +9, -7

```diff
diff --git a/frontend/src/pages/AdminPage.jsx b/frontend/src/pages/AdminPage.jsx
index e4bac35..3239a80 100644
--- a/frontend/src/pages/AdminPage.jsx
+++ b/frontend/src/pages/AdminPage.jsx
@@ -59,9 +59,9 @@ export default function AdminPage() {
       setLoading(true);
       try {
         const [productsRes, ordersRes, postsRes] = await Promise.all([
-          axios.get(`${API_BASE_URL}/products?raw=true`),
-          axios.get(`${API_BASE_URL}/orders`),
-          axios.get(`${API_BASE_URL}/blog`),
+          axios.get(`${API_BASE_URL}/admin/products`, { withCredentials: true }),
+          axios.get(`${API_BASE_URL}/orders`, { withCredentials: true }),
+          axios.get(`${API_BASE_URL}/blog`, { withCredentials: true }),
         ]);
 
         const productData = productsRes.data || [];
@@ -123,6 +123,7 @@ export default function AdminPage() {
         .map((c) => c.trim())
         .filter(Boolean),
       isFeatured: !!form.isFeatured,
+      status: 'active',
     };
   };
 
@@ -243,8 +244,9 @@ export default function AdminPage() {
       if (editingProductId) {
         // UPDATE
         response = await axios.put(
-          `${API_BASE_URL}/products/${editingProductId}`,
-          payload
+          `${API_BASE_URL}/admin/products/${editingProductId}`,
+          payload,
+          { withCredentials: true }
         );
         const updated = response.data?.data || response.data;
 
@@ -256,7 +258,7 @@ export default function AdminPage() {
         successToast('Product updated');
       } else {
         // CREATE
-        response = await axios.post(`${API_BASE_URL}/products`, payload);
+        response = await axios.post(`${API_BASE_URL}/admin/products`, payload, { withCredentials: true });
         const created = response.data?.data || response.data;
 
         const newProducts = [...products, created];
@@ -298,7 +300,7 @@ export default function AdminPage() {
     if (!window.confirm('Delete this product?')) return;
 
     try {

... (diff truncated, 5 more lines)
```


### `frontend/src/pages/SurfacePage.jsx`

**Changes:** +253, -1

```diff
diff --git a/frontend/src/pages/SurfacePage.jsx b/frontend/src/pages/SurfacePage.jsx
index 2379185..7607ee0 100644
--- a/frontend/src/pages/SurfacePage.jsx
+++ b/frontend/src/pages/SurfacePage.jsx
@@ -1,4 +1,5 @@
 import React, { useEffect, useMemo, useState } from "react";
+import { toast } from "react-toastify";
 import {
   AlertTriangle,
   Clock3,
@@ -133,6 +134,19 @@ function resolveOutputUrl(output, manifest) {
   return `${SURFACE_ASSET_BASE}/${rel}`;
 }
 
+function deriveSubfolderFromUrl(manifestObj, manifestUrl, jobId) {
+  if (manifestObj?.subfolder) return manifestObj.subfolder;
+  const url = manifestUrl || "";
+  const parts = url.split("/").filter(Boolean);
+  const idx = parts.indexOf("surface");
+  if (idx >= 0) {
+    const maybeSubfolder = parts[idx + 1];
+    const maybeJob = parts[idx + 2];
+    if (maybeJob === jobId) return maybeSubfolder || "";
+  }
+  return "";
+}
+
 function resolvePreviewsFromManifest(manifest) {
   const previews = manifest?.public?.previews || manifest?.public?.blender_previews_urls || {};
   const publicRoot = (manifest?.public_root || manifest?.public?.public_root || "").replace(/\/+$/, "");
@@ -302,6 +316,21 @@ export default function SurfacePage() {
   const [startedAt, setStartedAt] = useState(null);
   const [previewBust, setPreviewBust] = useState(Date.now());
 
+  const [isAdmin, setIsAdmin] = useState(false);
+  const [adminChecked, setAdminChecked] = useState(false);
+  const [promoteOpen, setPromoteOpen] = useState(false);
+  const [promoteSaving, setPromoteSaving] = useState(false);
+  const [promoteError, setPromoteError] = useState("");
+  const [promoteForm, setPromoteForm] = useState({
+    title: "",
+    price: 129,
+    category: "surface",
+    description: "",
+    tags: "",
+    sku: "",
+    freeze_assets: true,
+  });
+
   const [heightmapJobs, setHeightmapJobs] = useState([]);

... (diff truncated, 283 more lines)
```


### `frontend/src/pages/__tests__/SurfacePage.test.jsx`

**Changes:** +9, -6

```diff
diff --git a/frontend/src/pages/__tests__/SurfacePage.test.jsx b/frontend/src/pages/__tests__/SurfacePage.test.jsx
index 50bc18c..e335098 100644
--- a/frontend/src/pages/__tests__/SurfacePage.test.jsx
+++ b/frontend/src/pages/__tests__/SurfacePage.test.jsx
@@ -62,12 +62,15 @@ describe("SurfacePage heightmap integration", () => {
     installLocalStorage();
     jest.useFakeTimers();
 
-    global.fetch = jest.fn((url, opts = {}) => {
-      if (opts.method === "HEAD") {
-        return Promise.resolve({ ok: true, status: 200, headers: { get: () => "123" } });
-      }
-      return Promise.resolve({ ok: true, status: 200, json: async () => ({ ok: true, jobs: { items: [] } }) });
-    });
+      global.fetch = jest.fn((url, opts = {}) => {
+        if (opts.method === "HEAD") {
+          return Promise.resolve({ ok: true, status: 200, headers: { get: () => "123" } });
+        }
+        if (typeof url === "string" && url.includes("/api/admin/session")) {
+          return Promise.resolve({ ok: true, status: 200, json: async () => ({ loggedIn: false }) });
+        }
+        return Promise.resolve({ ok: true, status: 200, json: async () => ({ ok: true, jobs: { items: [] } }) });
+      });
 
     createSurfaceJob.mockResolvedValue({ job_id: "surface-job-1" });
     getSurfaceJobStatus.mockResolvedValue({ status: "complete", progress: 100, manifest_url: "/assets/surface/demo/job_manifest.json" });
```


### `nginx/default.conf`

**Changes:** +13, -1

```diff
diff --git a/nginx/default.conf b/nginx/default.conf
index 5007d82..f5480cd 100644
--- a/nginx/default.conf
+++ b/nginx/default.conf
@@ -155,7 +155,19 @@ server {
     location ^~ /assets/surface/ {
         alias /var/www/hexforge3d/surface/;
         autoindex off;
-        add_header Cache-Control "public, max-age=86400" always;
+
+        set $surface_cache_control "public, max-age=86400";
+        if ($uri ~* "job_manifest\.json$") {
+            set $surface_cache_control "no-store, no-cache, must-revalidate";
+        }
+        if ($uri ~* "(preview|hero).*(png|jpg|jpeg|webp)$") {
+            set $surface_cache_control "no-store, no-cache, must-revalidate";
+        }
+
+        add_header Cache-Control $surface_cache_control always;
+        if ($surface_cache_control = "no-store, no-cache, must-revalidate") {
+            add_header Pragma "no-cache" always;
+        }
         add_header X-Content-Type-Options "nosniff" always;
 
         types {
```


### `scripts/e2e_surface_proof.sh`

**Changes:** +228, -0

```diff
diff --git a/scripts/e2e_surface_proof.sh b/scripts/e2e_surface_proof.sh
new file mode 100755
index 0000000..85bf074
--- /dev/null
+++ b/scripts/e2e_surface_proof.sh
@@ -0,0 +1,228 @@
+#!/usr/bin/env bash
+set -euo pipefail
+
+# End-to-end proof that Surface consumes the requested heightmap URL and produces usable assets.
+# Usage:
+#   SURFACE_BASE_URL=https://localhost \
+#   HEIGHTMAP_URL=/assets/heightmap/demo.png \
+#   ./scripts/e2e_surface_proof.sh
+#
+# Optional:
+#   HEIGHTMAP_JOB_ID=<id>     # fetches heightmap URL from the heightmap API
+#   SURFACE_API_KEY=...       # forwarded to surface proxy
+#   HEIGHTMAP_API_KEY=...     # forwarded to heightmap API
+#   SURFACE_DEFAULT_SUBFOLDER=proof-run
+
+if [[ -n "${BASE_URL:-}" ]]; then
+  BASE_URL="${BASE_URL}"
+  BASE_URL_SOURCE="BASE_URL"
+elif [[ -n "${SURFACE_SMOKE_BASE_URL:-}" ]]; then
+  BASE_URL="${SURFACE_SMOKE_BASE_URL}"
+  BASE_URL_SOURCE="SURFACE_SMOKE_BASE_URL"
+elif [[ -n "${SURFACE_BASE_URL:-}" ]]; then
+  BASE_URL="${SURFACE_BASE_URL}"
+  BASE_URL_SOURCE="SURFACE_BASE_URL"
+else
+  BASE_URL="https://localhost"
+  BASE_URL_SOURCE="default"
+fi
+SUBFOLDER=${SURFACE_DEFAULT_SUBFOLDER:-proof-run}
+HEIGHTMAP_URL=${HEIGHTMAP_URL:-}
+HEIGHTMAP_JOB_ID=${HEIGHTMAP_JOB_ID:-}
+HEIGHTMAP_API_BASE=${HEIGHTMAP_API_BASE:-${BASE_URL}/api/heightmap}
+SURFACE_API=${BASE_URL}/api/store/surface
+API_KEY_HEADER=${SURFACE_API_KEY:+-H "x-api-key: ${SURFACE_API_KEY}"}
+HEIGHTMAP_API_KEY_HEADER=${HEIGHTMAP_API_KEY:+-H "x-api-key: ${HEIGHTMAP_API_KEY}"}
+POLL_SECONDS=240
+SLEEP_SECONDS=4
+
+CURL_FLAGS=(-sS)
+if [[ "${CURL_INSECURE:-0}" == "1" ]]; then
+  CURL_FLAGS+=(-k)
+fi
+
+log() { printf "[%s] %s\n" "$(date -u +%H:%M:%S)" "$*" >&2; }

... (diff truncated, 184 more lines)
```


### `scripts/smoke_surface_stack.sh`

**Changes:** +110, -21

```diff
diff --git a/scripts/smoke_surface_stack.sh b/scripts/smoke_surface_stack.sh
index e629431..b28ee29 100755
--- a/scripts/smoke_surface_stack.sh
+++ b/scripts/smoke_surface_stack.sh
@@ -5,19 +5,109 @@ set -euo pipefail
 # Requires an existing heightmap asset URL (public) produced by the Heightmap pipeline.
 # Usage: SURFACE_SMOKE_BASE_URL=https://localhost SURFACE_HEIGHTMAP_URL=/assets/heightmap/demo.png ./scripts/smoke_surface_stack.sh
 
-BASE_URL=${SURFACE_SMOKE_BASE_URL:-https://localhost}
-HEIGHTMAP_URL=${SURFACE_HEIGHTMAP_URL:-}
+if [[ -n "${BASE_URL:-}" ]]; then
+  BASE_URL="${BASE_URL}"
+  BASE_URL_SOURCE="BASE_URL"
+elif [[ -n "${SURFACE_SMOKE_BASE_URL:-}" ]]; then
+  BASE_URL="${SURFACE_SMOKE_BASE_URL}"
+  BASE_URL_SOURCE="SURFACE_SMOKE_BASE_URL"
+elif [[ -n "${SURFACE_BASE_URL:-}" ]]; then
+  BASE_URL="${SURFACE_BASE_URL}"
+  BASE_URL_SOURCE="SURFACE_BASE_URL"
+else
+  BASE_URL="https://localhost"
+  BASE_URL_SOURCE="default"
+fi
+if [[ -n "${HEIGHTMAP_URL:-}" ]]; then
+  HEIGHTMAP_URL="${HEIGHTMAP_URL}"
+  HEIGHTMAP_URL_SOURCE="HEIGHTMAP_URL"
+elif [[ -n "${SURFACE_HEIGHTMAP_URL:-}" ]]; then
+  HEIGHTMAP_URL="${SURFACE_HEIGHTMAP_URL}"
+  HEIGHTMAP_URL_SOURCE="SURFACE_HEIGHTMAP_URL"
+else
+  HEIGHTMAP_URL=""
+  HEIGHTMAP_URL_SOURCE="unset"
+fi
 SUBFOLDER=${SURFACE_DEFAULT_SUBFOLDER:-smoke-test}
 API_KEY_HEADER=${SURFACE_API_KEY:+-H "x-api-key: ${SURFACE_API_KEY}"}
 POLL_SECONDS=120
 SLEEP_SECONDS=3
 
+CURL_FLAGS=(-sS)
+if [[ "${CURL_INSECURE:-0}" == "1" ]]; then
+  CURL_FLAGS+=(-k)
+fi
+
+log() { printf "[%s] %s\n" "$(date -u +%H:%M:%S)" "$*" >&2; }
+log "BASE_URL: ${BASE_URL} (source: ${BASE_URL_SOURCE})"
+log "HEIGHTMAP_URL source: ${HEIGHTMAP_URL_SOURCE}"
+
+maybe_upgrade_base() {
+  if [[ "${BASE_URL}" =~ ^https:// ]]; then
+    return

... (diff truncated, 133 more lines)
```


### `scripts/smoke_surface_ui_check.sh`

**Changes:** +99, -13

```diff
diff --git a/scripts/smoke_surface_ui_check.sh b/scripts/smoke_surface_ui_check.sh
index a9b45dc..cbabe31 100755
--- a/scripts/smoke_surface_ui_check.sh
+++ b/scripts/smoke_surface_ui_check.sh
@@ -4,36 +4,120 @@ set -euo pipefail
 # Lightweight UI-facing smoke: hit proxy status + manifest and verify assets resolve.
 # Usage: SURFACE_SMOKE_BASE_URL=https://localhost SURFACE_DEFAULT_SUBFOLDER=smoke-test ./scripts/smoke_surface_ui_check.sh <job_id>
 
-BASE_URL=${SURFACE_SMOKE_BASE_URL:-https://localhost}
+if [[ -n "${BASE_URL:-}" ]]; then
+  BASE_URL="${BASE_URL}"
+  BASE_URL_SOURCE="BASE_URL"
+elif [[ -n "${SURFACE_SMOKE_BASE_URL:-}" ]]; then
+  BASE_URL="${SURFACE_SMOKE_BASE_URL}"
+  BASE_URL_SOURCE="SURFACE_SMOKE_BASE_URL"
+elif [[ -n "${SURFACE_BASE_URL:-}" ]]; then
+  BASE_URL="${SURFACE_BASE_URL}"
+  BASE_URL_SOURCE="SURFACE_BASE_URL"
+else
+  BASE_URL="https://localhost"
+  BASE_URL_SOURCE="default"
+fi
 JOB_ID=${1:-}
 SUBFOLDER=${SURFACE_DEFAULT_SUBFOLDER:-smoke-test}
 API_KEY_HEADER=${SURFACE_API_KEY:+-H "x-api-key: ${SURFACE_API_KEY}"}
 
+CURL_FLAGS=(-sS)
+if [[ "${CURL_INSECURE:-0}" == "1" ]]; then
+  CURL_FLAGS+=(-k)
+fi
+
+log() { printf "[%s] %s\n" "$(date -u +%H:%M:%S)" "$*" >&2; }
+log "BASE_URL: ${BASE_URL} (source: ${BASE_URL_SOURCE})"
+
+maybe_upgrade_base() {
+  if [[ "${BASE_URL}" =~ ^https:// ]]; then return; fi
+  local hdr status location
+  hdr=$(mktemp)
+  status=$(curl "${CURL_FLAGS[@]}" -I "${BASE_URL}" -o /dev/null -D "${hdr}" -w "%{http_code}")
+  location=$(grep -i "^location:" "${hdr}" | tail -n1 | awk '{print $2}' | tr -d '\r')
+  if [[ "${status}" =~ ^30[12]$ && "${location}" =~ ^https:// ]]; then
+    log "Detected HTTPâ†’HTTPS redirect. Switching BASE_URL to ${location}"
+    BASE_URL="${location%/}"
+  fi
+  rm -f "${hdr}"
+}
+
+curl_json() {
+  local url="$1"; shift
+  local body hdr status ct effective

... (diff truncated, 107 more lines)
```


## Review Checklist

Use this checklist to ensure the changes meet quality standards:

### Code Quality
- [ ] Code follows project style guidelines (.editorconfig, linting rules)
- [ ] No unnecessary code or debug statements (console.log, print, etc.)
- [ ] Functions and variables have meaningful names
- [ ] Complex logic is commented appropriately
- [ ] Code is DRY (Don't Repeat Yourself)

### Testing
- [ ] Unit tests added/updated for new functionality
- [ ] Integration tests updated if needed
- [ ] All existing tests still pass
- [ ] Edge cases are covered
- [ ] Test coverage is maintained or improved

### Documentation
- [ ] Public APIs are documented (JSDoc, docstrings)
- [ ] README files updated if needed
- [ ] Architecture docs updated for significant changes
- [ ] CHANGELOG updated (if applicable)

### Security
- [ ] No hardcoded secrets or credentials
- [ ] User inputs are validated and sanitized
- [ ] Authentication/authorization properly implemented
- [ ] No SQL injection vulnerabilities
- [ ] No XSS vulnerabilities
- [ ] Dependencies are up-to-date and secure

### Performance
- [ ] No obvious performance bottlenecks introduced
- [ ] Database queries are optimized (indexes, limits)
- [ ] Large datasets are paginated
- [ ] Caching is used where appropriate

### Breaking Changes
- [ ] No breaking changes, or they are well-documented
- [ ] Migration path provided for breaking changes
- [ ] Backward compatibility maintained where possible

### Other
- [ ] Commit messages follow conventional commit format
- [ ] PR description is clear and complete
- [ ] Related issues are linked
- [ ] No merge conflicts

## Notes for Reviewers

<!-- Add any additional context, decisions, or notes for reviewers here -->

## Related Links

- **Pull Request:** [Link to PR]
- **Related Issues:** [Links to related issues]
- **Documentation:** [Links to relevant docs]

---

**Generated:** 2026-01-20  
**Script Version:** 1.0
