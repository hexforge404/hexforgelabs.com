# Audit Report â€“ 2026-01-15

## Context
- Branch: feature/heightmap-engine-extract
- Scope: heightmap engine proxy, backend contract validation, smoke + backend tests

## Actions Taken
- Ran heightmap smoke: `bash scripts/smoke-heightmap.sh` (now defaults to http://localhost:8000)
- Ran backend tests: `cd backend && npm test`
- Restarted backend container to pick up schema changes

## Outcomes
- Heightmap smoke: **PASS** after fixes
- Backend tests: **PASS** (surface, heightmap, contractValidation)

## Issues Found & Resolved
1) Smoke script failing to parse job_id and status; heredoc parsing warnings. 
   - Fixed parsing and BASE default in [scripts/smoke-heightmap.sh](../scripts/smoke-heightmap.sh#L1-L51).

2) Heightmap job status failed contract (`MISSING_RESULT_PUBLIC`) because Ajv `removeAdditional: "all"` stripped `result.public` (schema lacked property definition). 
   - Added explicit `result.public` property to job status schema to preserve public links in [backend/schemas/job_status.schema.json](../backend/schemas/job_status.schema.json#L1-L60).
   - Restarted backend; smoke now returns complete status with assets.

3) Surface docs proxy test asserted old fetch signature (URL-only). 
   - Updated expectation to allow headers and AbortController signal in [backend/tests/surface.contract.test.js](../backend/tests/surface.contract.test.js#L90-L111).

## Current Service State
- Containers: backend (healthy), heightmapengine (healthy), nginx running. Heightmap proxy endpoint reachable at `http://localhost:8000/api/heightmap`.

## Follow-ups
- If deploying behind TLS, optionally set `BASE=https://localhost` when running smoke.
- Consider expanding job_status schema to fully describe result payload (enclosure/textures/previews) if stricter validation is desired.
